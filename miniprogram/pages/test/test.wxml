<!--pages/test/test.wxml-->
<view class="container">
  <!-- åŠ è½½çŠ¶æ€ -->
  <view class="loading-container" wx:if="{{loading}}">
    <view class="loading-content">
      <view class="loading-icon">ğŸ“</view>
      <view class="loading-text">æ­£åœ¨åŠ è½½é¢˜ç›®...</view>
      <view class="loading-tip">è¯·ç¨å€™ç‰‡åˆ»</view>
    </view>
  </view>

  <!-- æµ‹è¯•å¼€å§‹ç•Œé¢ -->
  <view class="start-container" wx:if="{{!loading && !testStarted}}">
    <view class="start-header">
      <view class="start-icon">{{testInfo[testType].icon}}</view>
      <view class="start-title">{{testInfo[testType].title}}</view>
      <view class="start-subtitle">{{testInfo[testType].subtitle}}</view>
    </view>

    <view class="start-content">
      <view class="test-description">
        <text class="description-title">æµ‹è¯•è¯´æ˜</text>
        <text class="description-text">â€¢ è¯·æ ¹æ®è‡ªå·±çš„çœŸå®æƒ…å†µå›ç­”é—®é¢˜</text>
        <text class="description-text">â€¢ ä¸è¦è¿‡å¤šæ€è€ƒï¼Œé€‰æ‹©ç¬¬ä¸€æ„Ÿè§‰çš„ç­”æ¡ˆ</text>
        <text class="description-text">â€¢ æ‰€æœ‰é¢˜ç›®æ²¡æœ‰å¯¹é”™ä¹‹åˆ†</text>
      </view>

      <view class="start-tips">
        <view class="tips-item">
          <text class="tips-icon">âš¡</text>
          <text class="tips-text">æµ‹è¯•æ—¶é—´çº¦{{testType === 'simple' ? '5-8' : '15-20'}}åˆ†é’Ÿ</text>
        </view>
        <view class="tips-item">
          <text class="tips-icon">ğŸ¯</text>
          <text class="tips-text">å»ºè®®åœ¨å®‰é™ç¯å¢ƒä¸‹å®Œæˆ</text>
        </view>
        <view class="tips-item">
          <text class="tips-icon">ğŸ’¾</text>
          <text class="tips-text">è¿›åº¦è‡ªåŠ¨ä¿å­˜ï¼Œå¯éšæ—¶é€€å‡ºç»§ç»­</text>
        </view>
      </view>
    </view>

    <view class="start-actions">
      <button class="btn-primary" bindtap="startTest">å¼€å§‹æµ‹è¯•</button>
      <button class="btn-secondary" bindtap="confirmExit">è¿”å›é¦–é¡µ</button>
    </view>
  </view>

  <!-- æµ‹è¯•è¿›è¡Œç•Œé¢ -->
  <view class="test-container" wx:if="{{!loading && testStarted}}">
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <view class="test-header">
      <view class="header-left">
        <view class="nav-button" bindtap="confirmExit">
          <text class="nav-icon">â†</text>
          <text class="nav-text">é€€å‡º</text>
        </view>
      </view>
      <view class="header-center">
        <view class="timer-text">{{formatTime(timeSpent)}}</view>
      </view>
      <view class="header-right">
        <view class="nav-button" bindtap="manualSaveProgress">
          <text class="nav-icon">ğŸ’¾</text>
          <text class="nav-text">ä¿å­˜</text>
        </view>
      </view>
    </view>

    <!-- è¿›åº¦æ¡ -->
    <view class="progress-section">
      <view class="progress-info">
        <text class="progress-text">ç¬¬ {{currentQuestion + 1}} é¢˜ / å…± {{totalQuestions}} é¢˜</text>
        <text class="progress-percent">{{progress}}%</text>
      </view>
      <view class="progress-bar">
        <view class="progress-fill" style="width: {{progress}}%"></view>
      </view>
    </view>

    <!-- é¢˜ç›®æ˜¾ç¤º -->
    <view class="question-container" wx:if="{{questions.length > 0}}">
      <view class="question-header">
        <view class="question-number">ç¬¬{{currentQuestion + 1}}é¢˜</view>
        <view class="question-category" wx:if="{{testType === 'simple'}}">
          {{questions[currentQuestion].dimension_group === 'EI' ? 'ç²¾åŠ›æ¥æº' : 
            questions[currentQuestion].dimension_group === 'SN' ? 'ä¿¡æ¯è·å–' : 
            questions[currentQuestion].dimension_group === 'TF' ? 'å†³ç­–æ–¹å¼' : 'ç”Ÿæ´»æ–¹å¼'}}
        </view>
      </view>

      <view class="question-content">
        <view class="question-text">{{questions[currentQuestion].question_text}}</view>
        
        <view class="options-container">
          <!-- simple æ¨¡å¼ï¼šA/B å›ºå®šä¸¤é¡¹ -->
          <block wx:if="{{testType === 'simple'}}">
            <view 
              class="option-item {{currentAnswer === 'A' ? 'selected' : ''}}"
              data-option="A"
              bindtap="selectAnswer"
              hover-class="none"
            >
              <view class="option-label" hover-class="none">A</view>
              <view class="option-content" hover-class="none">
                <view class="option-text" hover-class="none">{{questions[currentQuestion].option_a.text}}</view>
                <view class="option-dimension" hover-class="none">
                  {{questions[currentQuestion].option_a.dimension === 'E' ? 'å¤–å‘' : 
                    questions[currentQuestion].option_a.dimension === 'I' ? 'å†…å‘' :
                    questions[currentQuestion].option_a.dimension === 'S' ? 'æ„Ÿè§‰' : 
                    questions[currentQuestion].option_a.dimension === 'N' ? 'ç›´è§‰' :
                    questions[currentQuestion].option_a.dimension === 'T' ? 'æ€è€ƒ' :
                    questions[currentQuestion].option_a.dimension === 'F' ? 'æƒ…æ„Ÿ' :
                    questions[currentQuestion].option_a.dimension === 'J' ? 'åˆ¤æ–­' : 'æ„ŸçŸ¥'}}
                </view>
              </view>
            </view>

            <view 
              class="option-item {{currentAnswer === 'B' ? 'selected' : ''}}"
              data-option="B"
              bindtap="selectAnswer"
              hover-class="none"
            >
              <view class="option-label" hover-class="none">B</view>
              <view class="option-content" hover-class="none">
                <view class="option-text" hover-class="none">{{questions[currentQuestion].option_b.text}}</view>
                <view class="option-dimension" hover-class="none">
                  {{questions[currentQuestion].option_b.dimension === 'E' ? 'å¤–å‘' : 
                    questions[currentQuestion].option_b.dimension === 'I' ? 'å†…å‘' :
                    questions[currentQuestion].option_b.dimension === 'S' ? 'æ„Ÿè§‰' : 
                    questions[currentQuestion].option_b.dimension === 'N' ? 'ç›´è§‰' :
                    questions[currentQuestion].option_b.dimension === 'T' ? 'æ€è€ƒ' :
                    questions[currentQuestion].option_b.dimension === 'F' ? 'æƒ…æ„Ÿ' :
                    questions[currentQuestion].option_b.dimension === 'J' ? 'åˆ¤æ–­' : 'æ„ŸçŸ¥'}}
                </view>
              </view>
            </view>
          </block>

          <!-- detailed æ¨¡å¼ï¼šåŸºäº options æ•°ç»„æ¸²æŸ“ -->
          <block wx:elif="{{testType === 'detailed'}}">
            <block wx:for="{{questions[currentQuestion].options}}" wx:key="label">
              <view 
                class="option-item {{currentAnswer === item.label ? 'selected' : ''}}"
                data-label="{{item.label}}"
                bindtap="selectAnswer"
                hover-class="none"
              >
                <view class="option-label" hover-class="none">{{item.label}}</view>
                <view class="option-content" hover-class="none">
                  <view class="option-text" hover-class="none">{{item.text}}</view>
                </view>
              </view>
            </block>
          </block>
        </view>
      </view>
    </view>

    <!-- åº•éƒ¨å¯¼èˆª -->
    <view class="test-footer">
      <button 
        class="nav-button-secondary {{currentQuestion === 0 ? 'disabled' : ''}}"
        bindtap="prevQuestion"
        disabled="{{currentQuestion === 0}}"
      >
        ä¸Šä¸€é¢˜
      </button>
      
      <view class="footer-info">
        <text class="footer-progress">{{currentAnswer ? 'å·²é€‰æ‹©' : 'è¯·é€‰æ‹©'}}</text>
      </view>
      
      <button 
        class="nav-button-primary"
        bindtap="nextQuestion"
        wx:if="{{currentAnswer}}"
      >
        {{currentQuestion === totalQuestions - 1 ? 'å®Œæˆæµ‹è¯•' : 'ä¸‹ä¸€é¢˜'}}
      </button>
    </view>
  </view>

  <!-- é€€å‡ºç¡®è®¤å¼¹çª— -->
  <view class="modal-overlay" wx:if="{{showConfirmExit}}" bindtap="cancelExit">
    <view class="modal-content" catchtap="">
      <view class="modal-header">
        <view class="modal-icon">âš ï¸</view>
        <view class="modal-title">ç¡®è®¤é€€å‡ºæµ‹è¯•</view>
      </view>
      
      <view class="modal-body">
        <text class="modal-text">æ‚¨çš„ç­”é¢˜è¿›åº¦å°†è‡ªåŠ¨ä¿å­˜ï¼Œä¸‹æ¬¡å¯ä»¥ç»§ç»­å®Œæˆæµ‹è¯•ã€‚ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</text>
      </view>
      
      <view class="modal-footer">
        <button class="modal-btn-secondary" bindtap="cancelExit">å–æ¶ˆ</button>
        <button class="modal-btn-primary" bindtap="confirmExitTest">ç¡®è®¤é€€å‡º</button>
      </view>
    </view>
  </view>
</view>